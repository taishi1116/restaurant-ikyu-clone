// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema
generator client {
  provider = "prisma-client-js"
}

generator erd {
  provider = "prisma-erd-generator"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PlanTimeZone {
  DINNER
  LUNCH
}

enum Gender {
  MEN
  WOMEN
}

enum EmployeeRole {
  MANAGER // 店長
  STAFF // スタッフ
}

// 管理者 一休レストランの管理者
model Admins {
  id     String @id @db.Uuid
  authId String @unique @map("auth_id")
  name   String
  email  String @unique

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("admins")
}

// 従業員 レストランの運営側 店長,スタッフという権限が存在する
model Employees {
  id           String       @id @db.Uuid
  authId       String       @unique @map("auth_id")
  restaurantId String       @map("restaurant_id") @db.Uuid
  name         String
  email        String       @unique
  role         EmployeeRole
  isDeleted    Boolean      @default(false) @map("is_deleted")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  restaurant Restaurants @relation(fields: [restaurantId], references: [id])

  @@map("employees")
}

model Restaurants {
  id             String  @id @db.Uuid
  paymentId      String  @unique @map("payment_id") @db.Uuid
  stripeId       String  @unique @map("stripe_id")
  name           String
  phoneNumber    String  @map("phone_number")
  address        String
  nearestStation String? @map("nearest_station") // 最寄駅
  access         String // アクセス
  closedDay      String  @map("closed_day") // レストラン側にテキスト形式で入力してもらう仕様っぽいのでString

  // 店舗紹介関連のカラム
  introductionTitle   String @map("introduction_title") @db.Char(35) // 長すぎると良くないので35文字制限
  introductionContent String @map("introduction_content") @db.Char(200)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  employees Employees[]
  plans     Plans[]
  images    RestaurantImages[]
  payment   Payments?
  features  RestaurantFeatures[]

  @@map("restaurants")
}

model RestaurantImages {
  id           String @id @db.Uuid
  restaurantId String @map("restaurant_id") @db.Uuid
  bytes        Bytes  @map("image_byte") // 本来ならs3などを利用したいがお金が発生するのでバイナリでの保存

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  restaurant Restaurants @relation(fields: [restaurantId], references: [id])

  @@map("restaurant_images")
}

model RestaurantFeatures {
  id           String @id @db.Uuid
  restaurantId String @map("restaurant_id") @db.Uuid
  title        String @db.Char(35)
  description  String @db.Char(200)
  image        Bytes? // 本来ならs3などを利用したいがお金が発生するのでバイナリでの保存

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  restaurant Restaurants @relation(fields: [restaurantId], references: [id])

  @@map("restaurant_features")
}

// レストランの支払い情報
model Payments {
  id                String @id @db.Uuid
  restaurantsId     String @unique @db.Uuid
  serviceChargeRate Float  @map("service_charge_rate") // サービス料金(%)
  coverCharge       Int    @map("cover_charge") // チャージ料金(金額)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  restaurants Restaurants                    @relation(fields: [restaurantsId], references: [id])
  methods     PaymentsPaymentMethodsMaster[]

  @@map("payments")
}

// レストランの会計方法マスタ
// 一休では「テーブル or レジ」 しか存在しなかったが複数選択可 and 今後の拡張性を考慮してマスタ化
model PaymentMethodsMaster {
  id   String @id @db.Uuid
  name String

  paymentPaymentMethodsMaster PaymentsPaymentMethodsMaster[]

  @@map("payment_methods_master")
}

// レストランの会計方法とマスタは多対多の関係なので中間テーブルで紐付ける
model PaymentsPaymentMethodsMaster {
  paymentId             String @map("payment_id") @db.Uuid
  paymentMethodMasterId String @map("payment_method_master_id") @db.Uuid

  payment Payments             @relation(fields: [paymentId], references: [id])
  method  PaymentMethodsMaster @relation(fields: [paymentMethodMasterId], references: [id])

  @@id([paymentId, paymentMethodMasterId])
  @@map("payments_payment_methods")
}

model Plans {
  id           String       @id @db.Uuid
  restaurantId String       @map("restaurant_id") @db.Uuid
  name         String
  timeZone     PlanTimeZone @map("time_zone")
  description  String // 説明文
  // todo メニューは画像と文章の組み合わせだったのでそこをどうするか検討
  menu         String // メニュー内容
  price        Int
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  restaurant Restaurants? @relation(fields: [restaurantId], references: [id])
  cources    Cource[]

  @@map("plans")
}

model Cource {
  id     String @id @db.Uuid
  planId String @map("plan_id") @db.Uuid

  Plans Plans? @relation(fields: [planId], references: [id])

  @@map("cources")
}

// ゲスト レストランの利用者
model guests {
  id         String  @id @db.Uuid
  name       String
  email      String  @unique
  gender     Gender
  birthYear  Int
  birthMonth Int
  birthDay   Int
  postCode   Int
  isDeleted  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
